<html><head><script>var canvas, ctx, runtext, output, scroll, playbut;var added_poly_point, moved_object, started_new_poly, added_agent, add_goal, remove_goal, cpp_progress, set_goal;function init() {    canvas = document.getElementById("canvas")    ctx = canvas.getContext("2d")    runtext = document.getElementById("runtext")    output = document.getElementById("output")    scroll = document.getElementById("scroll")    playbut = document.getElementById("play")    Module.ccall('cpp_start', null);    added_poly_point = Module.cwrap('added_poly_point', null, ['number', 'number']);    moved_object = Module.cwrap('moved_object', null, ['number', 'number', 'number']);     started_new_poly = Module.cwrap('started_new_poly', null)    added_agent = Module.cwrap('added_agent', null, ['number', 'number'])    add_goal = Module.cwrap('add_goal', 'number', ['number', 'number'])    remove_goal = Module.cwrap('remove_goal', null, ['number'])    set_goal = Module.cwrap('set_goal', null, ['number', 'number'])    cpp_progress = Module.cwrap('cpp_progress', null, ['number'])        canvas.onmousedown = handleMouseDown;    document.onmouseup = handleMouseUp;    document.onmousemove = handleMouseMove;    canvas.ondblclick = handleDblClick;    canvas.onclick = handleClick;        resize();    canvas_cont.scrollLeft = 400;    canvas_cont.scrollTop = 500;    progress();}function Transform() {  this.reset()}Transform.prototype.reset = function() {  this.m = [1,0,0,1,0,0];};Transform.prototype.translate = function(x, y) {  this.m[4] += this.m[0] * x + this.m[2] * y;  this.m[5] += this.m[1] * x + this.m[3] * y;};Transform.prototype.scale = function(sx, sy) {  this.m[0] *= sx; this.m[1] *= sx;  this.m[2] *= sy; this.m[3] *= sy;};Transform.prototype.invert = function() {  var d = 1 / (this.m[0] * this.m[3] - this.m[1] * this.m[2]);  var m0 = this.m[3] * d, m1 = -this.m[1] * d;  var m2 = -this.m[2] * d, m3 = this.m[0] * d;  var m4 = d * (this.m[2] * this.m[5] - this.m[3] * this.m[4]);  var m5 = d * (this.m[1] * this.m[4] - this.m[0] * this.m[5]);  var nt = new Transform()  nt.m[0] = m0; nt.m[1] = m1; nt.m[2] = m2;  nt.m[3] = m3; nt.m[4] = m4; nt.m[5] = m5;  return nt};Transform.prototype.transformPoint = function(px, py) {  var x = px, y = py;  px = x * this.m[0] + y * this.m[2] + this.m[4];  py = x * this.m[1] + y * this.m[3] + this.m[5];  return {x:px, y:py};};var drawObjects = {} // zOrder -> {ptr -> objects}var objects = {} // ptr -> objectvar pressedObject = null; // object that is currently pressed downvar pressedStart = null; // offset// offset from the center of the object at the moment of mouse down so that the first move would not be jerkyvar mouseDownOffset = {x:0, y:0} ;var addingPoly = false;var addingAgent = false;var selectSquare = null; // x1, y1, x2, y2, isActivevar multiSelected = []; // objects that were multi selectedvar activeGoals = {}; // ptr -> truevar isPlaying = true;var dt = new Transform()function getXY(event) {    var inv = dt.invert()        //return {x: event.clientX - canvas.offsetLeft + canvas_cont.scrollLeft,    //        y: event.clientY - canvas.offsetTop + canvas_cont.scrollTop }    var p = inv.transformPoint(event.clientX - canvas.offsetLeft + canvas_cont.scrollLeft,                              event.clientY - canvas.offsetTop + canvas_cont.scrollTop)    return p                          }function zoomValue() {    return 1 + ((zoom_scroll.value) / 100.0)}function handleMouseDown(event) {    var c = getXY(event);    var x = c.x, y = c.y;    for(z in drawObjects) {        for(p in drawObjects[z]) {            var o = drawObjects[z][p];            if (o.isInside(x, y)) {                pressedObject = o;                mouseDownOffset.x = pressedObject.x - x                mouseDownOffset.y = pressedObject.y - y                pressedStart = {x:x, y:y}                return true;            }                    }    }    if (addingPoly) {        added_poly_point(x, y)        return true;    }    if (addingAgent) {        added_agent(x, y)        return true;    }    if (!selectSquare) {        selectSquare = {x1:x, y1:y, x2:x, y2:y}        return true;    }        return true // prevent cursor change}function handleClick(event) {}function clearMultiSel() {    multiSelected = []    for(i in objects) {        objects[i].isSelected = false;    }}function handleDblClick(event) {    clearMultiSel()    return false;}function selSquareBig() {    return selectSquare.width > 10 && selectSquare.height > 10}function pressedMoveLittle(x, y) {    if (pressedStart == null)        return true;    return Math.abs(pressedStart.x - x) <= 5 && Math.abs(pressedStart.y - y) <= 5}function handleMouseUp(event) {    var c = getXY(event);    var x = c.x, y = c.y;    if (selectSquare && !selectSquare.isActive &&  multiSelected.length > 0) {        setGoal(x, y, multiSelected);    }    else if ((!selectSquare || !selSquareBig()) && pressedObject != null && pressedObject.multiSel && pressedMoveLittle(x, y)) {        clearMultiSel()        multiSelected = [pressedObject]        pressedObject.isSelected = true    }        pressedObject = null    selectSquare = null;    return true;}function handleMouseMove(event) {    var c = getXY(event);    var x = c.x, y = c.y;    if (selectSquare) {        selectSquare.x2 = x;        selectSquare.y2 = y;        selectSquare.xmin = Math.min(selectSquare.x1, selectSquare.x2);        selectSquare.ymin = Math.min(selectSquare.y1, selectSquare.y2);        selectSquare.width = Math.abs(selectSquare.x1 - selectSquare.x2);        selectSquare.height = Math.abs(selectSquare.y1 - selectSquare.y2)        if (selSquareBig()) {            clearMultiSel()            for(i in objects) {                if (objects[i].isInRect(selectSquare)) {                    selectSquare.isActive = true;                    multiSelected.push(objects[i])                    objects[i].isSelected = true;                }                else                     objects[i].isSelected = false;            }        }    }    if (pressedObject) {        pressedObject.x = x + mouseDownOffset.x;        pressedObject.y = y + mouseDownOffset.y;                moved_object(pressedObject.ptr, pressedObject.x, pressedObject.y)    }    //draw()    return true;}function out(s) {    //output.innerHTML += s + "<br>"    console.log(s);}function clear_objects() {    objects = {};}function remove_object(ptr) {    delete drawObjects[objects[ptr].zOrder][ptr]    delete objects[ptr];}function add_object(ptr, zOrder, obj) {    obj.ptr = ptr;    obj.zOrder = zOrder;    objects[ptr] = obj;    if (!(zOrder in drawObjects))        drawObjects[zOrder] = []        drawObjects[zOrder][ptr] = obj;}function setGoal(x, y, selAgents) {    var goalPtr = add_goal(x, y) // will do add_circle    activeGoals[goalPtr] = true    for(i in selAgents) {        selAgents[i].goalPtr = goalPtr        set_goal(selAgents[i].ptr, goalPtr);    }    var usedGoals = {}    for(i in objects) {        if (objects[i].goalPtr)            usedGoals[objects[i].goalPtr] = true    }    for(i in activeGoals) {        if (!(i in usedGoals)) {            remove_goal(i);            delete activeGoals[i];        }    }}function Circle(x, y, radius, color, multiSel) {    this.x = x;    this.y = y;    this.radius = radius;    this.color = color;    this.multiSel = multiSel;    this.isSelected = false;    this.goalPtr = null;}Circle.prototype.draw1 = function() {    if (this.isSelected) {        ctx.beginPath();        ctx.arc(this.x, this.y, this.radius + 3, 0, 2 * Math.PI, false);        ctx.lineWidth = 2;        ctx.strokeStyle = "rgb(80,80,255)";        ctx.stroke();    }}Circle.prototype.draw2 = function() {    if (this.isSelected) {        ctx.beginPath();        ctx.arc(this.x, this.y, this.radius + 2, 0, 2 * Math.PI, false);        ctx.fillStyle = "#ffffff";        ctx.fill()    }}Circle.prototype.draw3 = function() {    ctx.beginPath();    ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);    ctx.fillStyle = this.color;    ctx.fill();    ctx.lineWidth = 0.5;    ctx.strokeStyle = '#000000';    ctx.stroke();}Circle.prototype.isInside = function(x, y) {    return (x >= this.x - this.radius && x <= this.x + this.radius          && y >= this.y - this.radius && y <= this.y + this.radius);}Circle.prototype.isInRect = function(rect) {    if (!this.multiSel)        return false;    return (this.x >= rect.xmin && this.x <= rect.xmin + rect.width &&            this.y >= rect.ymin && this.y <= rect.ymin + rect.height) }function add_circle(ptr, zOrder, x, y, radius, color, multiSelectable) {    add_object(ptr, zOrder, new Circle(x, y, radius, color, multiSelectable));}function Triangle(ax, ay, bx, by, cx, cy, color) {    this.ax = ax; this.ay = ay;    this.bx = bx; this.by = by;    this.cx = cx; this.cy = cy;    this.color = color}Triangle.prototype.draw1 = function() {    ctx.beginPath();    ctx.moveTo(this.ax, this.ay);    ctx.lineTo(this.bx, this.by);    ctx.lineTo(this.cx, this.cy);    ctx.lineTo(this.ax, this.ay);    ctx.fillStyle = this.color;    ctx.fill()    ctx.lineWidth = 0.5;    ctx.strokeStyle = 'rgb(50,50,150)';    ctx.stroke()}Triangle.prototype.draw2 = Triangle.prototype.draw3 = function() {}Triangle.prototype.isInside = function(x, y) {    return false;}Triangle.prototype.isInRect = function(rect) {    return false;}function add_tri(ptr, zOrder, ax, ay, bx, by, cx, cy) {    add_object(ptr, zOrder, new Triangle(ax, ay, bx, by, cx, cy, "rgb(205,205,255)"))}function move_object(ptr, x, y) {    o = objects[ptr];    o.x = x;    o.y = y;}function draw() {    ctx.setTransform(1,0,0,1,0,0)    ctx.clearRect(0, 0, canvas.width, canvas.height);    ctx.setTransform(dt.m[0], dt.m[1], dt.m[2], dt.m[3], dt.m[4], dt.m[5]);    ctx.strokeStyle = "#000"    ctx.lineWidth = 2;    ctx.strokeRect(0, 0, canvas.width, canvas.height);        for(z in drawObjects) {        for(p in drawObjects[z]) {            drawObjects[z][p].draw1();        }        for(p in drawObjects[z]) {            drawObjects[z][p].draw2();        }        for(p in drawObjects[z]) {            drawObjects[z][p].draw3();        }            }        if (selectSquare) {        ctx.fillStyle = "rgba(0,0,70,0.2)"        ctx.fillRect(selectSquare.xmin, selectSquare.ymin, selectSquare.width, selectSquare.height);        ctx.setLineDash([5])        ctx.strokeRect(selectSquare.xmin, selectSquare.ymin, selectSquare.width, selectSquare.height);        ctx.setLineDash([])    }}function progress() {    if (isPlaying)        cpp_progress(0.4);    draw();    window.requestAnimationFrame(progress)}function triggerPolyline() {    addingPoly = !addingPoly;    if (addingAgent && addingPoly) {        triggerAgent();        document.getElementById("checkboxAgent").checked = false    }        var label = document.getElementById("polyLabel")    if (addingPoly)        label.innerHTML = "End Polyline"    else        label.innerHTML = "Start Polyline"    started_new_poly();    }function triggerAgent() {    addingAgent = !addingAgent;    if (addingAgent && addingPoly) {        triggerPolyline();        document.getElementById("checkboxPoly").checked = false    }}function resize() {    canvas_cont.style.width = window.innerWidth - 150 - 8*2;    canvas_cont.style.height = window.innerHeight - 30 - 8*2;}function playstop() {    isPlaying = !isPlaying    play_but.value = isPlaying ? "Stop" : "Play"}function zoomChanged() {    var s = zoomValue()    var cx = canvas_cont.scrollLeft + canvas_cont.offsetWidth*0.5    var cy = canvas_cont.scrollTop + canvas_cont.offsetHeight*0.5    dt.reset()    dt.translate(cx, cy)    dt.scale(s, s)    dt.translate(-cx, -cy)    canvas.style.width = 2000*s;    canvas.style.height = 2000*s;}</script><script src="js_main.js"></script><style>body { /* disable selection so the double click will not select */   -webkit-touch-callout: none;   -webkit-user-select: none;   -khtml-user-select: none;   -moz-user-select: none;   -ms-user-select: none;   user-select: none;   margin:0;   background: #333333;}#canvas {    background: #fff;    border:solid #000 2px;}#canvas_cont {    overflow: scroll;    width: 80%;    height: 80%;    margin: 8px;}#but_ctrl {    position: absolute;    right: 0;    top: 0;    width: 150px;    background: #eeeeee;}#frame_ctrl {    position: absolute;    bottom: 0;    left: 0;    height: 30px;}#zoom_scroll {    position: absolute;    left: 0;    top: 100;    height:150px;    width: 30px;    -webkit-appearance: slider-vertical;    writing-mode: bt-lr;}</style></head><body onload="init()" onresize="resize()">  <div id="canvas_cont">    <canvas id="canvas" width="2000" height="2000"></canvas>  </div>  <div id="but_ctrl"><div id="but_rel" style="position:relative;">          <input id="play_but" type="button" value="Stop" onclick="playstop()"/>      <br>      <input id="checkboxPoly" type="checkbox" onclick="triggerPolyline()"/><label id="polyLabel" for="checkboxPoly">Start Polyline</label>      <br>      <input id="checkboxAgent" type="checkbox" onclick="triggerAgent()"/><label id="agentLabel" for="checkboxAgent">Add Agents</label>      <input id="zoom_scroll" type="range" orient="vertical" name="zoom" min="-80" max="150" value="0" oninput="zoomChanged()"/>   </div></div>    <div id="frame_ctrl">  <input id="scroll" type="range" name="points" min="0" max="100" value="0" style="width:700px"/>  </div></body></html>